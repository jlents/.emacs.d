(ns paychecks.db
  (:require [monger.core :as m]
            [monger.command :as cmd]
            [monger.collection :as col]
            [monger.conversion :as conv :refer [from-db-object]]
            [monger.result :as res]
            [monger.query :as q]
            [monger.operators :refer :all]
            [clojure.core.cache :refer :all]
            [monger.cache :refre :all])
  (:import [org.bson.types ObjectId]
           [com.mongodb MongoClient DB WriteConcern MongoClientOptions])
  (:gen-class))

(defn create-conn
  "Creates the connection to MongoDB." [host port]
  (m/connect (m/server-address host port) (m/mongo-options {:connections-per-host 100})))

(defn mongo-setup
  "Sets connection parameters and returns the DB object, under the assumption
  that a single DB will be used." [conn db db-user db-pwd]
  (m/authenticate (m/get-db conn db) db-user (.toCharArray db-pwd))
  (m/set-default-write-concern! WriteConcern/JOURNAL_SAFE)
  (m/get-db conn db))

(defn mongo-shutdown
  "Disconnect from MongoDB." [conn]
  (m/disconnect conn))

;;; Data insertion.

(defn put-map
  "Given a collection, insert a map as a document."
  [db col m]
  (res/ok? (col/insert db col m)))

(defn put-maps
  "Given a collection, insert a vector of maps."
  [db col v]
  (res/ok? (col/insert-batch db col v)))

;;; Data retrieval.

(defn get-map
  "Get a document from a collection, given some criteria.
  e.g. (get-map \"person\" {:nameFirst \"JOHN\"})"
  [db col m]
  (col/find-one-as-map db col m))

(defn get-maps
  "Get multiple documents from a collection."
  ([db col]
    (col/find-maps db col))
  ([col db conditions]
    (col/find-maps db col conditions))
  ([col db conditions projection]
    (col/find-maps db col conditions projection))
  ([col db conditions projection sort-map]
    (q/with-collection db col
      (q/find conditions)
      (q/fields projection)
      (q/sort sort-map))))

(defn get-by-id
  "Get a document by _id.  Can take either and ObjectId or an id string."
  [db col id]
  (let [id (if (= org.bson.types.ObjectId (class id))
             id (ObjectId. id))]
    (col/find-one-as-map db col {:_id id})))

;; Custom querying.

(defn get-distinct-values
  "Get the distinct values for key from col."
  [db col key]
  (col/distinct db col key))
